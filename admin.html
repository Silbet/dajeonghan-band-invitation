<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 30px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 30px; }
        h1 { font-weight: 800; color: #333; margin-bottom: 20px; }
        .section-header { border-left: 5px solid #6c5ce7; padding-left: 15px; margin-bottom: 20px; }
        .badge-inviter { font-size: 0.9em; }
        .table th { background-color: #2d3436; color: white; }
        .btn-delete { font-size: 0.8rem; padding: 2px 8px; }

        /* [ë³´ì•ˆ] ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<!-- [ë³´ì•ˆ] ë¡œê·¸ì¸ í™”ë©´ (ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½) -->
<div id="login-overlay">
    <div class="login-box">
        <h3 class="mb-4 fw-bold">ğŸ”’ ê´€ë¦¬ì ì ‘ì†</h3>
        <p class="text-secondary mb-4">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        <input type="password" id="adminPasswordInput" class="form-control form-control-lg mb-3" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.keyCode==13) checkPassword();">
        <button onclick="checkPassword()" class="btn btn-primary w-100 btn-lg">ë¡œê·¸ì¸</button>
        <div id="loginMsg" class="mt-3 text-danger small"></div>
    </div>
</div>

<!-- [ë³´ì•ˆ] ë‚´ìš©ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ (ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë³´ì„) -->
<div id="admin-container" class="container" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <h1>ğŸ› ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        <div>
            <button onclick="logout()" class="btn btn-outline-danger me-2">ë¡œê·¸ì•„ì›ƒ</button>
            <button onclick="window.location.reload()" class="btn btn-dark">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>

    <!-- [ì„¹ì…˜ 1] ì°¸ì—¬ ì‹ ì²­ í˜„í™© -->
    <div class="card p-4">
        <h3 class="section-header d-flex justify-content-between">
            ğŸŸï¸ ì°¸ì—¬ ì‹ ì²­ í˜„í™©
            <span class="badge bg-primary rounded-pill" id="rsvpCount">0ëª…</span>
        </h3>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th width="5%">#</th>
                        <th width="20%">ì‹ ì²­ì¼ì‹œ</th>
                        <th width="15%">ë°©ë¬¸ì ì´ë¦„</th>
                        <th width="15%">ì´ˆëŒ€ì</th>
                        <th width="10%">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="rsvpTableBody">
                    <tr><td colspan="5" class="text-center py-3">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- [ì„¹ì…˜ 2] ë°©ëª…ë¡ í˜„í™© -->
    <div class="card p-4">
        <h3 class="section-header d-flex justify-content-between" style="border-color: #00b894;">
            ğŸ“ ë°©ëª…ë¡ í˜„í™©
            <span class="badge bg-success rounded-pill" id="guestbookCount">0ê°œ</span>
        </h3>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th width="5%">#</th>
                        <th width="20%">ì‘ì„±ì¼ì‹œ</th>
                        <th width="15%">ë‹‰ë„¤ì„</th>
                        <th width="50%">ë‚´ìš©</th>
                        <th width="10%">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="guestbookTableBody">
                    <tr><td colspan="5" class="text-center py-3">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, doc, deleteDoc } 
    from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // =================================================================
    // [ë³´ì•ˆ] ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (SHA-256 í•´ì‹œ)
    // =================================================================

    const ADMIN_HASH = "12d9634a066ef75f5c94fc8b7cc77250f4fbf254b79fe7252e36dc22d0b6d40c";

    // 1. SHA-256 í•´ì‹œ í•¨ìˆ˜ (HTTPS í™˜ê²½ í•„ìˆ˜)
    window.sha256 = async function(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

    // 2. ë¡œê·¸ì¸ í™•ì¸ í•¨ìˆ˜
    window.checkPassword = async function() {
        // HTTPS í™˜ê²½ ì²´í¬ (ë¡œì»¬í˜¸ìŠ¤íŠ¸ë‚˜ ê¹ƒí—ˆë¸Œ í˜ì´ì§€ì—ì„œëŠ” ì •ìƒ ì‘ë™)
        if (!window.isSecureContext) {
            alert("ë³´ì•ˆ ì˜¤ë¥˜: ì´ í˜ì´ì§€ëŠ” HTTPS(ê¹ƒí—ˆë¸Œ ë“±) í™˜ê²½ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤.");
            return;
        }

        const input = document.getElementById("adminPasswordInput").value;
        const msgDiv = document.getElementById("loginMsg");
        
        if (!input) {
            msgDiv.innerText = "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            return;
        }

        try {
            const inputHash = await window.sha256(input);
            
            if (inputHash === ADMIN_HASH) {
                // ë¡œê·¸ì¸ ì„±ê³µ!
                // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— 'ë¡œê·¸ì¸ë¨' ìƒíƒœ ì €ì¥ (ë¸Œë¼ìš°ì € ë‹«ê¸° ì „ê¹Œì§€ ìœ ì§€)
                sessionStorage.setItem("adminAuth", "true");
                
                showAdminScreen();
            } else {
                msgDiv.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
                document.getElementById("adminPasswordInput").value = "";
                document.getElementById("adminPasswordInput").focus();
            }
        } catch (e) {
            console.error(e);
            msgDiv.innerText = "ì•”í˜¸í™” ì˜¤ë¥˜ ë°œìƒ (ë¸Œë¼ìš°ì € ë²„ì „ì„ í™•ì¸í•˜ì„¸ìš”)";
        }
    }

    // 3. ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
    window.logout = function() {
        sessionStorage.removeItem("adminAuth");
        window.location.reload();
    }

    // 4. ê´€ë¦¬ì í™”ë©´ ë³´ì—¬ì£¼ê¸° & ë°ì´í„° ë¡œë“œ
    function showAdminScreen() {
        document.getElementById("login-overlay").style.display = "none";
        document.getElementById("admin-container").style.display = "block";
        initAdminPage();
    }

    // [ìë™ ë¡œê·¸ì¸ ì²´í¬] í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ í™•ì¸
    window.onload = function() {
        if (sessionStorage.getItem("adminAuth") === "true") {
            showAdminScreen();
        }
    }

    // =================================================================
    // [í•„ìˆ˜] ì—¬ê¸°ì— ë³¸ì¸ì˜ Firebase Configë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
    // =================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyAXBBLO3VVvrA3cNmcRLlrkEJdJqdLbjUo",
      authDomain: "band-concert-invite.firebaseapp.com",
      projectId: "band-concert-invite",
      storageBucket: "band-concert-invite.firebasestorage.app",
      messagingSenderId: "249455279668",
      appId: "1:249455279668:web:27c0d16d9c2cf987df9461",
      measurementId: "G-YDFCDHJJ71"
    };

    // Firebase ì´ˆê¸°í™” ë³€ìˆ˜
    let app, db;

    // ë°ì´í„° ë¡œë”© í•¨ìˆ˜ (ë¡œê·¸ì¸ ì„±ê³µ í›„ ì‹¤í–‰ë¨)
    function initAdminPage() {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);

        // ì‚­ì œ í•¨ìˆ˜
        window.deleteItem = async (collectionName, docId) => {
            if (confirm("ì •ë§ë¡œ ì´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‚­ì œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) {
                try {
                    await deleteDoc(doc(db, collectionName, docId));
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    window.location.reload();
                } catch (error) {
                    console.error("ì‚­ì œ ì‹¤íŒ¨:", error);
                    alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
                }
            }
        };

        // ë°ì´í„° ë¡œë“œ ì‹¤í–‰
        loadRsvps();
        loadGuestbook();
    }

    // 1. ì°¸ì—¬ ëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadRsvps() {
        const tableBody = document.getElementById("rsvpTableBody");
        const countSpan = document.getElementById("rsvpCount");

        try {
            const q = query(collection(db, "rsvps"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-secondary">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            let html = "";
            let count = 0;

            querySnapshot.forEach((doc) => {
                count++;
                const data = doc.data();
                const docId = doc.id; 
                
                let dateStr = "-";
                if (data.createdAt) {
                    const date = data.createdAt.toDate();
                    dateStr = `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                }

                html += `
                    <tr>
                        <td>${count}</td>
                        <td class="text-secondary small">${dateStr}</td>
                        <td class="fw-bold">${data.visitor}</td>
                        <td><span class="badge bg-secondary badge-inviter">${data.inviter}</span></td>
                        <td>
                            <button class="btn btn-danger btn-delete" onclick="deleteItem('rsvps', '${docId}')">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
            countSpan.innerText = count + "ëª…";

        } catch (error) {
            console.error(error);
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">ë¡œë“œ ì‹¤íŒ¨</td></tr>';
        }
    }

    // 2. ë°©ëª…ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadGuestbook() {
        const tableBody = document.getElementById("guestbookTableBody");
        const countSpan = document.getElementById("guestbookCount");

        try {
            const q = query(collection(db, "guestbook"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-secondary">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            let html = "";
            let count = 0;

            querySnapshot.forEach((doc) => {
                count++;
                const data = doc.data();
                const docId = doc.id;
                
                let dateStr = "-";
                if (data.createdAt) {
                    const date = data.createdAt.toDate();
                    dateStr = `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                }

                const content = data.content.length > 50 ? data.content.substring(0, 50) + "..." : data.content;

                html += `
                    <tr>
                        <td>${count}</td>
                        <td class="text-secondary small">${dateStr}</td>
                        <td class="fw-bold text-primary">${data.nickname}</td>
                        <td>${content}</td>
                        <td>
                            <button class="btn btn-danger btn-delete" onclick="deleteItem('guestbook', '${docId}')">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
            countSpan.innerText = count + "ê°œ";

        } catch (error) {
            console.error(error);
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">ë¡œë“œ ì‹¤íŒ¨</td></tr>';
        }
    }
</script>

</body>
</html>